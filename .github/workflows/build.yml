name: Build
on:
  push:
    branches: [ "*" ]
    tags: [ "v*"]
env:
  OPENTAP_ANSI_COLORS: true
  OPENTAP_NO_UPDATE_CHECK: true
  INSTANCE: 'Writerside/l'
  ARTIFACT: 'pdfSourceL.pdf'
  DOCKER_VERSION: '241.15989'

jobs:
  build-doc:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: baileyjm02/markdown-to-pdf@v1
        name: Build Docs
        with:
          input_dir: doc
          output_dir: pdfs
          images_dir: docs/images
          # for example <img src="./images/file-name.png">
          image_import: ./images
          # Default is true, can set to false to only get PDF files
          build_html: false

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: artifact
          path: artifacts/${{ env.ARTIFACT }}
          retention-days: 7
  build:
    runs-on: ubuntu-20.04
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Fix tags
      if: startsWith(github.ref, 'refs/tags/v')
      run: git fetch -f origin ${{ github.ref }}:${{ github.ref }}
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 6.0.x
    - name: Build
      run: |
        echo "${{ secrets.SIGN_SERVER_CERT }}" > $TAP_SIGN_CERT
        dotnet build -c Release
        cd bin/Release
        mkdir Packages/LabVIEW\ Examples/
        cp -r ../../Dependency/OpenTap.LabView.Test1/ Packages/LabVIEW\ Examples/
        ./tap package create --verbose -o LabVIEW.Example.TapPackage ../../package.example.xml
      env:
        TAP_SIGN_ADDRESS: ${{ secrets.TAP_SIGN_ADDRESS }}
        TAP_SIGN_AUTH: ${{ secrets.TAP_SIGN_AUTH }}
        TAP_SIGN_CERT: ${{ github.workspace }}/sign.cer
        Ks8500Token: ${{secrets.KS8500TOKEN}}
          
    # - name: Run Unit Tests
    #  working-directory: bin/Release
    #  run: ./tap unit-test run

    - name: Upload binaries
      uses: actions/upload-artifact@v2
      with:
        name: TapPackage
        retention-days: 14
        path: |
          bin/Release/*.TapPackage

  publish:
    if: false
    environment: packages.opentap.io
    runs-on: ubuntu-20.04
    needs: build
    steps:
    - name: Download binaries
      uses: actions/download-artifact@v2
      with:
        name: TapPackage
        path: bin/Release/
    - name: Setup OpenTAP
      uses: opentap/setup-opentap@v1.0
      with:
        version: 9.22.0-rc.2
        packages: 'Repository Client:beta'
    - name: Publish Packages
      working-directory: bin/Release
      run: |
        tap repo upload --repository http://packages.opentap.io --token ${{ secrets.OPENTAP_IO_TOKEN }} LabVIEW.*.TapPackage
      
